kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ include "mysql-cluster.fullname" . }}
data:
  my.cnf: |
    [mysqld]
    ndbcluster
    port={{ $.Values.mysql.ports.management }}
    user={{ .Values.securityContext.runAsUser | default "mysql" }}
    ndb-connectstring={{ include "mysql-cluster.fullname" . }}-mgm:{{ .Values.mysql.ports.management }}

    [mysql_cluster]
    connect-string={{ include "mysql-cluster.fullname" . }}-mgm:{{ .Values.mysql.ports.management }}

  mysql-cluster.cnf: |
    {{- $currentNodeId := 1 }}

    [ndb_mgmd default]
    PortNumber={{ .Values.mysql.ports.management }}
    DataDir={{ .Values.mysql.node.dataDir }}

    {{- range $managementNodeId, $replicas := until (.Values.mysql.managementNode.replicas | int) }}
    [ndb_mgmd]
    HostName={{ printf "%s-mgm-%d.%s-mgm.%s.svc.%s" (include "mysql-cluster.fullname" $) $managementNodeId (include "mysql-cluster.fullname" $) $.Release.Namespace $.Values.clusterName }}
    NodeId={{ $currentNodeId }}
    {{ $currentNodeId = (add $currentNodeId 1) }}
    {{- end }}

    [ndbd default]
    NoOfReplicas={{ .Values.mysql.dataNode.replicas }}
    DataDir={{ .Values.mysql.node.dataDir }}
    DataMemory={{ .Values.mysql.dataNode.dataMemory }}

    {{- if .Values.mysql.dataNode.lockPagesInMainMemory }}
    LockPagesInMainMemory=1
    {{- end }}

    {{- if .Values.mysql.dataNode.oDirectWrites }}
    ODirect=1
    {{- end }}

    {{- range $dataNodeId, $replicas := until (.Values.mysql.dataNode.replicas | int) }}
    [ndbd]
    HostName={{ printf "%s-data-%d.%s-data.%s.svc.%s" (include "mysql-cluster.fullname" $) $dataNodeId (include "mysql-cluster.fullname" $) $.Release.Namespace $.Values.clusterName }}
    NodeId={{ $currentNodeId }}
    {{ $currentNodeId = (add $currentNodeId 1) }}
    {{- end }}

    {{- range $sqlNodeId, $clientConnections := until (.Values.mysql.sqlNode.replicas | int) }}
    [mysqld]
    NodeId={{ $currentNodeId }}
    {{ $currentNodeId = (add $currentNodeId 1) }}
    {{- end }}